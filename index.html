<!DOCTYPE html>
<html>
<head>
  <title>WebRTC Voice Call</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/6.0.1/signalr.min.js"></script>
</head>
<body>
  <h2>WebRTC Voice Call Test</h2>

  <p>Your ID: <span id="myId">...</span></p>
  <input id="targetId" placeholder="Enter target ID" />
  <button onclick="startCall()">Call</button>

  <h3>Remote Audio</h3>
  <audio id="remoteAudio" autoplay></audio>

  <script>
    let pc;
    let myId;
    const targetIdInput = document.getElementById("targetId");

    // Connect to backend hub
    const connection = new signalR.HubConnectionBuilder()
      .withUrl("https://callhubtest-bwcmhjgcbbhcfebn.canadacentral-01.azurewebsites.net/callHub")
      .build();

    // --- Fetch ICE servers from backend (Twilio TURN/STUN) ---
    async function getIceServers() {
      try {
        let res = await fetch("https://callhubtest-bwcmhjgcbbhcfebn.canadacentral-01.azurewebsites.net/api/turn");
        let iceServers = await res.json();
        console.log("Fetched ICE servers:", iceServers);
        return iceServers;
      } catch (err) {
        console.error("Failed to fetch ICE servers, falling back to Google STUN:", err);
        return [{ urls: "stun:stun.l.google.com:19302" }];
      }
    }

    // --- Create Peer Connection ---
    async function createPeerConnection() {
      let config = { iceServers: await getIceServers() };
      pc = new RTCPeerConnection(config);

      // Capture microphone
      let stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      stream.getTracks().forEach(track => pc.addTrack(track, stream));

      // Play remote audio
      pc.ontrack = (event) => {
        document.getElementById("remoteAudio").srcObject = event.streams[0];
      };

      // Send ICE candidates via SignalR
      pc.onicecandidate = (event) => {
        if (event.candidate && targetIdInput.value) {
          connection.invoke("SendIceCandidate", targetIdInput.value, JSON.stringify(event.candidate));
        }
      };
    }

    // --- Start Call ---
    async function startCall() {
      await createPeerConnection();

      let offer = await pc.createOffer();
      await pc.setLocalDescription(offer);

      connection.invoke("SendOffer", targetIdInput.value, JSON.stringify(offer));
    }

    // --- SignalR Events ---
    connection.on("ReceiveConnectionId", (id) => {
      myId = id;
      document.getElementById("myId").innerText = id;
      console.log("My connection ID:", id);
    });

    connection.on("ReceiveOffer", async (fromId, offer) => {
      await createPeerConnection();
      await pc.setRemoteDescription(new RTCSessionDescription(JSON.parse(offer)));

      let answer = await pc.createAnswer();
      await pc.setLocalDescription(answer);

      connection.invoke("SendAnswer", fromId, JSON.stringify(answer));
    });

    connection.on("ReceiveAnswer", async (fromId, answer) => {
      await pc.setRemoteDescription(new RTCSessionDescription(JSON.parse(answer)));
    });

    connection.on("ReceiveIceCandidate", async (fromId, candidate) => {
      await pc.addIceCandidate(new RTCIceCandidate(JSON.parse(candidate)));
    });

    // --- Start connection ---
    connection.start().catch(err => console.error("SignalR connection failed:", err));
  
  async function getIceServers() {
  let res = await fetch("https://callhubtest-bwcmhjgcbbhcfebn.canadacentral-01.azurewebsites.net/api/turn");
  let servers = await res.json();
  console.log("ICE servers:", servers);
  return servers;
}

  </script>
  
</body>
</html>
