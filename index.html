<!DOCTYPE html>
<html>
<head>
  <title>WebRTC Voice Call</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/6.0.1/signalr.min.js"></script>
</head>
<body>
  <h2>WebRTC Voice Call Test</h2>
  <p>Your ID: <span id="myId">...</span></p>
  <input id="targetId" placeholder="Enter target ID" />
  <button onclick="startCall()">Call</button>

  <h3>Remote Audio</h3>
  <audio id="remoteAudio" autoplay></audio>

  <script>
    let pc = new RTCPeerConnection({
  iceServers: [
    { urls: "stun:stun.l.google.com:19302" }
  ]
});

    let myId;
const connection = new signalR.HubConnectionBuilder()
  .withUrl("https://callhubtest-bwcmhjgcbbhcfebn.canadacentral-01.azurewebsites.net/callHub")  // backend URL
  .build();


    async function createPeerConnection() {
      pc = new RTCPeerConnection({
        iceServers: [{ urls: "stun:stun.l.google.com:19302" }]
      });

      // Capture mic
      let stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      stream.getTracks().forEach(track => pc.addTrack(track, stream));

      // Play remote audio
      pc.ontrack = (event) => {
        document.getElementById("remoteAudio").srcObject = event.streams[0];
      };

      // Send ICE to target
     pc.onicecandidate = (event) => {
  if (event.candidate && targetIdInput.value) {
    connection.invoke("SendIceCandidate", targetIdInput.value,
      JSON.stringify(event.candidate));
  }
};

connection.on("ReceiveIceCandidate", async (fromId, candidate) => {
  await pc.addIceCandidate(new RTCIceCandidate(JSON.parse(candidate)));
});

    }

    const targetIdInput = document.getElementById("targetId");

    async function startCall() {
      await createPeerConnection();

      let offer = await pc.createOffer();
      await pc.setLocalDescription(offer);

      connection.invoke("SendOffer", targetIdInput.value, JSON.stringify(offer));
    }

    // --- SignalR Events ---
    connection.on("YourConnectionId", (id) => {
      myId = id;
      document.getElementById("myId").innerText = id;
    });

    connection.on("ReceiveOffer", async (fromId, offer) => {
      await createPeerConnection();
      await pc.setRemoteDescription(new RTCSessionDescription(JSON.parse(offer)));

      let answer = await pc.createAnswer();
      await pc.setLocalDescription(answer);

      connection.invoke("SendAnswer", fromId, JSON.stringify(answer));
    });

    connection.on("ReceiveAnswer", async (fromId, answer) => {
      await pc.setRemoteDescription(new RTCSessionDescription(JSON.parse(answer)));
    });

    connection.on("ReceiveIceCandidate", async (fromId, candidate) => {
      await pc.addIceCandidate(new RTCIceCandidate(JSON.parse(candidate)));
    });

    connection.start();
  </script>
</body>
</html>
