<!DOCTYPE html>
<html>
<head>
  <title>WebRTC Voice Call</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/6.0.1/signalr.min.js"></script>
</head>
<body>
  <h2>WebRTC Voice Call Test</h2>

  <p>Your ID: <span id="myId">...</span></p>
  <input id="targetId" placeholder="Enter target ID" />
  <button onclick="startCall()">ğŸ“ Call</button>

  <div id="incoming" style="display:none; margin-top:20px;">
    <p>ğŸ“² Incoming call from <span id="callerId"></span></p>
    <button onclick="acceptCall()">âœ… Accept</button>
    <button onclick="rejectCall()">âŒ Reject</button>
  </div>

  <h3>Remote Audio</h3>
  <audio id="remoteAudio" autoplay playsinline></audio>

  <script>
    let pc;
    let myId;
    let pendingOffer;   // store offer until user accepts
    let callerId;       // store caller ID
    const targetIdInput = document.getElementById("targetId");

    // --- Connect to backend SignalR hub ---
    const connection = new signalR.HubConnectionBuilder()
      .withUrl("https://callhubtest-bwcmhjgcbbhcfebn.canadacentral-01.azurewebsites.net/callHub")
      .build();

    // --- Fetch ICE servers from backend ---
    async function getIceServers() {
      try {
        let res = await fetch("https://callhubtest-bwcmhjgcbbhcfebn.canadacentral-01.azurewebsites.net/api/turn");
        let data = await res.json();

        // Add Google STUN for redundancy
        let iceServers = [
          { urls: "stun:stun.l.google.com:19302" },
          ...data.iceServers
        ];

        console.log("Using ICE servers:", iceServers);
        return iceServers;
      } catch (err) {
        console.error("Failed to fetch ICE servers, falling back to Google STUN:", err);
        return [{ urls: "stun:stun.l.google.com:19302" }];
      }
    }

    // --- Create Peer Connection ---
    async function createPeerConnection() {
      let config = { iceServers: await getIceServers() };
      pc = new RTCPeerConnection(config);

      // Capture microphone
      let stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      stream.getTracks().forEach(track => pc.addTrack(track, stream));
      console.log("Microphone stream added:", stream);

      // Play remote audio
      pc.ontrack = (event) => {
        console.log("Remote track received:", event.streams[0]);
        document.getElementById("remoteAudio").srcObject = event.streams[0];
      };

      // Send ICE candidates
      pc.onicecandidate = (event) => {
        if (event.candidate) {
          const target = targetIdInput.value || callerId;
          if (target) {
            connection.invoke("SendIceCandidate", target, JSON.stringify(event.candidate));
            console.log("Sent ICE candidate to:", target);
          }
        }
      };

      pc.onconnectionstatechange = () => {
        console.log("PeerConnection state:", pc.connectionState);
      };
    }

    // --- Start Outgoing Call ---
    async function startCall() {
      console.log("Starting call...");
      await createPeerConnection();

      let offer = await pc.createOffer();
      await pc.setLocalDescription(offer);

      console.log("Sending offer:", offer);
      connection.invoke("SendOffer", targetIdInput.value, JSON.stringify(offer));
    }

    // --- Accept Call (callee) ---
    async function acceptCall() {
      console.log("Accepting call from:", callerId);
      document.getElementById("incoming").style.display = "none";
      await createPeerConnection();

      console.log("Setting remote description (offer)");
      await pc.setRemoteDescription(new RTCSessionDescription(JSON.parse(pendingOffer)));

      let answer = await pc.createAnswer();
      await pc.setLocalDescription(answer);

      console.log("Sending answer:", answer);
      connection.invoke("SendAnswer", callerId, JSON.stringify(answer));
    }

    // --- Reject Call ---
    function rejectCall() {
      console.log("Call rejected from:", callerId);
      document.getElementById("incoming").style.display = "none";
      pendingOffer = null;
      callerId = null;
    }

    // --- SignalR Events ---
    connection.on("ReceiveConnectionId", (id) => {
      myId = id;
      document.getElementById("myId").innerText = id;
      console.log("My connection ID:", id);
    });

    connection.on("ReceiveOffer", async (fromId, offer) => {
      console.log("Incoming call from:", fromId);
      callerId = fromId;
      pendingOffer = offer;

      document.getElementById("callerId").innerText = fromId;
      document.getElementById("incoming").style.display = "block";
    });

    connection.on("ReceiveAnswer", async (fromId, answer) => {
      console.log("Answer received from:", fromId);
      await pc.setRemoteDescription(new RTCSessionDescription(JSON.parse(answer)));
    });

    connection.on("ReceiveIceCandidate", async (fromId, candidate) => {
      try {
        await pc.addIceCandidate(new RTCIceCandidate(JSON.parse(candidate)));
        console.log("ICE candidate added from:", fromId);
      } catch (err) {
        console.error("Error adding ICE candidate:", err);
      }
    });

    // --- Start connection ---
    connection.start()
      .then(() => console.log("SignalR connected"))
      .catch(err => console.error("SignalR connection failed:", err));
  </script>
</body>
</html>
