<!DOCTYPE html>
<html>
<head>
  <title>WebRTC Voice Call</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/6.0.1/signalr.min.js"></script>
</head>
<body>
  <h2>WebRTC Voice Call Test</h2>

  <p>Your ID: <span id="myId">...</span></p>
  <input id="targetId" placeholder="Enter target ID" />
  <button onclick="startCall()">📞 Call</button>

  <div id="incoming" style="display:none; margin-top:20px;">
    <p>📲 Incoming call from <span id="callerId"></span></p>
    <button onclick="acceptCall()">✅ Accept</button>
    <button onclick="rejectCall()">❌ Reject</button>
  </div>

  <h3>Remote Audio</h3>
  <audio id="remoteAudio" autoplay playsinline></audio>

  <script>
    let pc;
    let myId;
    let pendingOffer;
    let callerId;
    const targetIdInput = document.getElementById("targetId");

    const connection = new signalR.HubConnectionBuilder()
      .withUrl("https://callhubtest-bwcmhjgcbbhcfebn.canadacentral-01.azurewebsites.net/callHub")
      .build();

    // ✅ Fetch ICE servers from your backend only
   async function getIceServers() {
  try {
    let res = await fetch("https://callhubtest-bwcmhjgcbbhcfebn.canadacentral-01.azurewebsites.net/api/turn");
    let data = await res.json();

    // Normalize Twilio response to proper format
    let twilioServers = [];
    if (data.ice_servers) {
      twilioServers = data.ice_servers.map(s => ({
        urls: s.urls || s.url,   // Twilio sometimes uses "url"
        username: s.username,
        credential: s.credential
      }));
    }

    let iceServers = [
      { urls: "stun:stun.l.google.com:19302" }, // backup STUN
      ...twilioServers
    ];

    console.log("Using ICE servers:", iceServers);
    return iceServers;
  } catch (err) {
    console.error("ICE fetch failed, fallback:", err);
    return [{ urls: "stun:stun.l.google.com:19302" }];
  }
}

    async function createPeerConnection() {
      let config = { iceServers: await getIceServers() };
      pc = new RTCPeerConnection(config);

      // Capture mic
      let stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      stream.getTracks().forEach(track => pc.addTrack(track, stream));
      console.log("Microphone added");

      // Play remote audio
      pc.ontrack = (event) => {
        console.log("Remote track received");
        document.getElementById("remoteAudio").srcObject = event.streams[0];
      };

      // Send ICE
      pc.onicecandidate = (event) => {
        if (event.candidate) {
          const target = targetIdInput.value || callerId;
          if (target) {
            connection.invoke("SendIceCandidate", target, JSON.stringify(event.candidate));
            console.log("Sent ICE candidate");
          }
        }
      };

      pc.oniceconnectionstatechange = () => {
        console.log("ICE state:", pc.iceConnectionState);
      };

      pc.onconnectionstatechange = () => {
        console.log("PeerConnection state:", pc.connectionState);
      };
    }

    // Caller
    async function startCall() {
      console.log("Starting call...");
      await createPeerConnection();

      let offer = await pc.createOffer();
      await pc.setLocalDescription(offer);

      connection.invoke("SendOffer", targetIdInput.value, JSON.stringify(offer));
      console.log("Offer sent");
    }

    // Callee
    async function acceptCall() {
      console.log("Accepting call");
      document.getElementById("incoming").style.display = "none";
      await createPeerConnection();

      await pc.setRemoteDescription(new RTCSessionDescription(JSON.parse(pendingOffer)));

      let answer = await pc.createAnswer();
      await pc.setLocalDescription(answer);

      connection.invoke("SendAnswer", callerId, JSON.stringify(answer));
      console.log("Answer sent");
    }

    function rejectCall() {
      console.log("Call rejected");
      document.getElementById("incoming").style.display = "none";
      pendingOffer = null;
      callerId = null;
    }

    // SignalR handlers
    connection.on("ReceiveConnectionId", (id) => {
      myId = id;
      document.getElementById("myId").innerText = id;
      console.log("My ID:", id);
    });

    connection.on("ReceiveOffer", (fromId, offer) => {
      console.log("Offer from:", fromId);
      callerId = fromId;
      pendingOffer = offer;
      document.getElementById("callerId").innerText = fromId;
      document.getElementById("incoming").style.display = "block";
    });

    connection.on("ReceiveAnswer", async (fromId, answer) => {
      console.log("Answer from:", fromId);
      await pc.setRemoteDescription(new RTCSessionDescription(JSON.parse(answer)));
    });

    connection.on("ReceiveIceCandidate", async (fromId, candidate) => {
      try {
        await pc.addIceCandidate(new RTCIceCandidate(JSON.parse(candidate)));
        console.log("Added ICE candidate from:", fromId);
      } catch (err) {
        console.error("Error adding ICE:", err);
      }
    });

    connection.start()
      .then(() => console.log("SignalR connected"))
      .catch(err => console.error("SignalR failed:", err));
  </script>
</body>
</html>
